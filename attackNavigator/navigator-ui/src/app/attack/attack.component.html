<ng-template #jsonView let-modal>
  <div class="modal-header">
    <h3 class="modal-title" id="modal-basic-title">STIX Viewer for: {{techId}}</h3>
    <button
      type="button"
      class="btn btn-outline-primary"
      style="float: right; margin-left: 50%; padding: 2px"
      cdkCopyToClipboard="{{ jsonValue }}"
    >
      Copy to clipboard
    </button>

    <button
      type="button"
      class="close"
      aria-label="Close"
      (click)="modal.dismiss('Cross click')"
    >
      <span aria-hidden="true">&times;</span>
    </button>
  </div>
  <div class="modal-body">
    <ngx-json-viewer
      [json]="textValue"
      [depth]="5"
    ></ngx-json-viewer>
  </div>
</ng-template>

<ng-template #content let-modal>
  <div class="modal-header">
    <h4 class="modal-title" id="modal-basic-title">{{ modal_header }}</h4>
    <button
      type="button"
      class="close"
      aria-label="Close"
      (click)="modal.dismiss('Cross click')"
    >
      <span aria-hidden="true">&times;</span>
    </button>
  </div>
  <div class="modal-body">
    <mat-tab-group>
      <mat-tab label="New Script">
        <br />
        <form [formGroup]="addForm">
          <div class="form-group">
            <div>
              <ng-multiselect-dropdown
                formControlName="technique_ids"
                [placeholder]="'Select Technique ID *'"
                [data]="allTechIds"
                [(ngModel)]="selectedItems"
                [settings]="dropdownSettings"
                (onSelect)="onItemSelect($event)"
                (onSelectAll)="onSelectAll($event)"
                (onDeSelect)="onItemDeSelect($event)"
                [disabled]="isTechIdDisabled"
                class="singleselect"
              >
                <ng-template
                  #optionsTemplate
                  let-item
                  let-option="option"
                  let-id="id"
                  let-isSelected="isSelected"
                >
                  {{ option }}
                </ng-template>

                <ng-template
                  #optionSelectedTemplate
                  optionSelectedTemplate
                  let-option="option"
                  let-id="id"
                >
                  {{ option }}
                </ng-template>
              </ng-multiselect-dropdown>
              <div *ngIf="addForm.controls['technique_ids'].errors?.required">
                Please select the Technique-Id.
              </div>

              <br />

              <select
                class="form-control"
                (change)="getSelectedTool($event)"
                formControlName="tool_selection"
              >
                <option [ngValue]="null" [disabled]="true">
                  Select Attack tool *
                </option>
                <option value="manual">Manual</option>
                <option value="atomicred">Atomic Red</option>
                <option value="caldera">Caldera</option>
                <option value="powersploit">Powersploit</option>
                <option value="empire">Empire</option>
                <option value="metasploit">Metasploit</option>
              </select>
              <br />

              <select class="form-control" formControlName="execution_status">
                <option [ngValue]="null" [disabled]="true">
                  Select Execution Status
                </option>
                <option>Pass</option>
                <option>Fail</option>
              </select>
              <br />
              <input
                type="file"
                class="form-control"
                formControlName="fileUpload"
                [attr.disabled]="disableFileUpload ? '' : null"
                (change)="onFileChange($event)"
              />
              <div *ngIf="disableFileUpload">
                File upload is only available for Atomic Red and Caldera tool
                selection.
              </div>
              <br />

              <ng-multiselect-dropdown
                formControlName="executor_selection"
                [placeholder]="'Select the Executor *'"
                [settings]="executorDropdownSettings"
                [data]="dropdownList"
                [(ngModel)]="selectedExecutorItems"
                (onSelect)="onExecutorItemSelect($event)"
                (onSelectAll)="onExecutorSelectAll($event)"
                (onDeSelect)="onExecutorItemDeSelect($event)"
                [disabled]="isFileUploaded"
              >
              </ng-multiselect-dropdown>
              <div
                *ngIf="addForm.controls['executor_selection'].errors?.required"
              >
                Please select Executor.
              </div>

              <div style="display: none">
                <br />
                <label for="Script">Script</label>
                <textarea
                  id="Script"
                  class="form-control"
                  formControlName="script"
                  rows="2"
                  cols="20"
                ></textarea>
              </div>

              <br />
              <textarea
                id="pre_command"
                class="form-control"
                formControlName="pre_command"
                placeholder="Please enter Pre-Command."
                rows="2"
                cols="20"
                [readonly]="isFileUploaded"
              ></textarea>
              <br />

              <textarea
                id="command"
                class="form-control"
                formControlName="command"
                placeholder="Please enter Command *."
                required
                [readonly]="isFileUploaded"
              ></textarea>
              <div *ngIf="addForm.controls['command'].errors?.required">
                Please enter Command.
              </div>

              <br />
              <textarea
                id="post_command"
                class="form-control"
                formControlName="post_command"
                placeholder="Please enter Post-Command."
                rows="2"
                cols="20"
                [readonly]="isFileUploaded"
              ></textarea>
              <br />
              <ngb-accordion #acc="ngbAccordion" activeIds="ngb-panel-0">
                <ngb-panel title="Input Arguments">
                  <ng-template ngbPanelContent>
                    <form #addressForm="ngForm" (ngSubmit)="logValue()">
                      <div class="row">
                        <div class="col-12">
                          <button
                            type="button"
                            class="btn btn-primary mb-2"
                            (click)="addInputArg()"
                            [disabled]="isFileUploaded"
                          >
                            Add
                          </button>
                          <section
                            class="container border mb-1"
                            *ngFor="
                              let inputarg of inputArgArray;
                              let i = index
                            "
                          >
                            <div class="row mt-2">
                              <div class="col-6">
                                <h4>Input Argument - {{ i + 1 }}</h4>
                              </div>
                              <div class="col-6 text-right">
                                <button
                                  type="button"
                                  class="btn btn-danger btn-sm"
                                  (click)="removeInputArg(i)"
                                >
                                  Remove
                                </button>
                              </div>
                            </div>
                            <div class="row">
                              <div class="col-6">
                                <div class="form-group">
                                  <input
                                    type="text"
                                    class="form-control"
                                    [(ngModel)]="inputarg.key"
                                    name="inputargKey_{{ inputarg.id }}"
                                    placeholder="Key"
                                  />
                                </div>
                              </div>
                              <div class="col-6">
                                <div class="form-group">
                                  <input
                                    type="text"
                                    class="form-control"
                                    [(ngModel)]="inputarg.value"
                                    name="inputargVal_{{ inputarg.id }}"
                                    placeholder="Value"
                                  />
                                </div>
                              </div>
                            </div>
                          </section>
                        </div>
                      </div>
                    </form>
                  </ng-template>
                </ngb-panel>
              </ngb-accordion>

              <br />
              <textarea
                id="cleanup"
                class="form-control"
                formControlName="cleanup"
                placeholder="Please enter Clean Up *."
                required
                [readonly]="isFileUploaded"
              ></textarea>
              <div *ngIf="addForm.controls['cleanup'].errors?.required">
                Please enter Clean Up.
              </div>

              <br />
              <input
                id="ability_name"
                class="form-control"
                formControlName="ability_name"
                placeholder="Please enter Ability Name."
                [readonly]="isFileUploaded"
              />

              <br />

              <input
                id="file_name"
                class="form-control"
                formControlName="file_name"
                placeholder="Please enter Filename."
                [readonly]="isFileUploaded"
              />

              <br />
              <textarea
                id="pre_requisite"
                class="form-control"
                formControlName="pre_requisite"
                placeholder="Please enter Pre-Requisite."
                rows="2"
                cols="20"
                [readonly]="isFileUploaded"
              ></textarea>
              <br />
              <select
                class="form-control"
                formControlName="platform"
                [disabled]="isFileUploaded"
              >
                <option [ngValue]="null" [disabled]="true">
                  Select Platform
                </option>
                <option
                  *ngFor="let pltform of allPlatforms"
                  [ngValue]="pltform"
                  [disabled]="isFileUploaded"
                >
                  {{ pltform }}
                </option>
              </select>

              <div style="display: none">
                <label for="script_type">script_type :- </label>
                <input
                  id="s_type"
                  class="form-control"
                  formControlName="script_type"
                />
              </div>

              <br />

              <textarea
                id="comment"
                class="form-control"
                placeholder="Please enter Comments."
                formControlName="comment"
                rows="2"
                cols="20"
              ></textarea>
            </div>
          </div>
        </form>
      </mat-tab>
      <mat-tab label="Show Data" [disabled]="showJson">
        <form [formGroup]="addForm">
          <div class="form-group">
            <br />
            <label for="Data">Data</label>
            <textarea
              id="jsondata"
              class="form-control"
              formControlName="jsondata"
              rows="10"
              cols="20"
              [readonly]="showJsonData"
            ></textarea>
          </div>

          <div style="float: right">
            <button
              type="button"
              class="btn btn-outline-dark"
              (click)="editJsonData()"
              style="margin-right: 10px"
            >
              Edit
            </button>
            <button
              type="button"
              class="btn btn-outline-dark"
              (click)="resetJsonData()"
            >
              Reset
            </button>
          </div>
        </form>
      </mat-tab>
    </mat-tab-group>
  </div>
  <div class="modal-footer">
    <button
      type="button"
      class="btn btn-outline-dark"
      style="margin-right: 10px"
      (click)="addMore(addForm)"
      [disabled]="!addForm.valid && !isFileUploaded"
    >
      Add More
    </button>
    <!-- <button type="button" class="btn btn-outline-dark" style="margin-right: 10px;" (click)="addMore(addForm)"
      >Add More</button> -->
    <button
      type="button"
      class="btn btn-outline-dark"
      (click)="submit(addForm)"
    >
      Submit
    </button>
  </div>
</ng-template>

<ng-template #updateContent let-modal>
  <div class="modal-header">
    <h4 class="modal-title" id="modal-basic-title">Profile update</h4>
    <button
      type="button"
      class="close"
      aria-label="Close"
      (click)="modal.dismiss('Cross click')"
    >
      <span aria-hidden="true">&times;</span>
    </button>
  </div>
  <div class="modal-body">
    <form>
      <div class="form-group">
        <div>
          <label for="Script">Script :- </label>
          <textarea
            id="Script"
            class="form-control"
            placeholder="script"
            name="Script"
            [(ngModel)]="modalContent.script"
            rows="5"
            cols="20"
          >
          </textarea>
          <br />

          <label for="Script">Pre-requisite </label>
          <textarea
            id="pre_requisite"
            class="form-control"
            name="pre_requisite"
            [(ngModel)]="modalContent.pre_requisite"
            rows="5"
            cols="20"
          >
          </textarea>

          <br />

          <label for="Script">Filename :- </label>
          <input
            id="file_name"
            class="form-control"
            name="file_name"
            [(ngModel)]="modalContent.file_name"
          />
          <br />

          <label for="Script">script_type :- </label>
          <input
            id="s_type"
            class="form-control"
            name="s_type"
            [(ngModel)]="modalContent.script_type"
          />

          <br />

          <label for="t_ids">Technique-Ids :- &nbsp;&nbsp;</label>

          <ng-multiselect-dropdown
            name="technique_ids"
            [placeholder]="'Select Technique ID'"
            [data]="allTechIds"
            [(ngModel)]="selectedItems"
            [settings]="dropdownSettings"
            (onSelect)="onItemSelect($event)"
            (onSelectAll)="onSelectAll($event)"
            (onDeSelect)="onItemDeSelect($event)"
          >
            <ng-template
              #optionsTemplate
              let-item
              let-option="option"
              let-id="id"
              let-isSelected="isSelected"
            >
              {{ option }}
            </ng-template>

            <ng-template
              #optionSelectedTemplate
              optionSelectedTemplate
              let-option="option"
              let-id="id"
            >
              {{ option }}
            </ng-template>
          </ng-multiselect-dropdown>
          <br />
          <label for="Comment">Comment</label>
          <textarea
            id="comment"
            class="form-control"
            name="comment"
            [(ngModel)]="modalContent.comment"
            required
            rows="2"
            cols="20"
          ></textarea>

          <br />
          <label for="Script">Support :- </label>
          <input
            type="checkbox"
            name="support"
            [(ngModel)]="modalContent.support"
          />
        </div>
      </div>
    </form>
  </div>
  <div class="modal-footer">
    <button
      type="button"
      class="btn btn-outline-dark"
      (click)="modal.close(modalContent)"
    >
      Save
    </button>
  </div>
</ng-template>

<hr />
<div class="row" style="width: 100%">
  <div
    class="col-sm-2 vr"
    *ngIf="hidenav"
    style="width: 14%; text-align: left; padding-left: 5px"
  >
    <br />

    <h3 style="padding: 0px">Filter Options:</h3>
    <div>
      <div appearance="fill" *ngFor="let filter of filterSelectObj">
        <select matNativeControl disabled></select>

        <ng-multiselect-dropdown
          [placeholder]="filter.name"
          [data]="filter.options"
          [(ngModel)]="filter.modelValue"
          [settings]="dropdownSettingsDS"
          (onSelect)="multiFilterChange(filter, $event)"
          (onSelectAll)="onSelectAllDS($event)"
          (onDeSelect)="multiFilterDeSelect(filter, $event)"
        >
          <ng-template
            #optionsTemplate
            let-item
            let-option="option"
            let-id="id"
            let-isSelected="isSelected"
          >
            {{ option }}
          </ng-template>

          <ng-template
            #optionSelectedTemplate
            optionSelectedTemplate
            let-option="option"
            let-id="id"
          >
            {{ option }}
          </ng-template>
        </ng-multiselect-dropdown>
      </div>
      <br />
      &nbsp;
      <button mat-flat-button color="warn" (click)="resetFilters()">
        Reset
      </button>
    </div>

    <hr />

    <label>
      <h3>Hide/Un-hide Column</h3>
    </label>
    <div style="margin-left: 10%">
      <input
        type="checkbox"
        ng-model-options="{ getterSetter: true }"
        (change)="filterColumn($event, 'sub_technique_id')"
        value="sub_technique_id"
        checked
      /><label>&nbsp; Technique id</label>
      <br />
      <input
        type="checkbox"
        ng-model-options="{ getterSetter: true }"
        (change)="filterColumn($event, 'mitre_version')"
        value="mitre_version"
        checked
      /><label>&nbsp; Mitre Version</label>
      <br />
      <input
        type="checkbox"
        ng-model-options="{ getterSetter: true }"
        (change)="filterColumn($event, 'script')"
        value="script"
        checked
      /><label>&nbsp; Script</label>
      <br />
      <input
        type="checkbox"
        ng-model-options="{ getterSetter: true }"
        (change)="filterColumn($event, 'comment')"
        value="data_source"
        checked
      /><label>&nbsp; Comment</label>
      <br />
      <input
        type="checkbox"
        ng-model-options="{ getterSetter: true }"
        (change)="filterColumn($event, 'support')"
        value="accuracy_score"
        checked
      /><label>&nbsp; Support</label>
    </div>
  </div>

  <div class="col-sm-10" style="width: 86%; text-align: center; float: right">
    <div class="navbar-dark fixed">
      <button
        class="btn btn-md btn-outline-primary"
        style="margin-right: 50px; float: right"
        id="addScript"
        (click)="open(content)"
      >
        Add
      </button>

      <button
        (click)="exporter.exportTable('csv', { fileName: 'Attack' })"
        id="CSVExport"
        class="btn btn-md btn-outline-primary"
        style="margin-right: 5px; float: right"
      >
        Export CSV
      </button>

    </div>
    <div class="form-group row">
      <mat-form-field
        floatLabel="never"
        appearance="fill"
        class="col-sm-8"
        style="padding-top: 0px"
      >
        <mat-label>Search here</mat-label>
        <input
          matInput
          id="name"
          #name
          name="search_here"
          [(ngModel)]="searchTextInput"
          (keyup)="applyPipeFilter($event)"
          style="font-size: large"
        />
        <mat-icon aria-label="Search icon" matSuffix>search</mat-icon>
      </mat-form-field>

      <span
        style="padding-top: 10px"
        *ngIf="dataSource.filteredData.length < AttackList.length"
      >
        <h3 style="text-align: justify; vertical-align: middle">
          {{ dataSource.filteredData.length }}/{{ AttackList.length }} attacks
          &nbsp;&nbsp; &nbsp;&nbsp;
        </h3>
      </span>

      <span
        style="padding-top: 10px"
        *ngIf="dataSource.filteredData.length == AttackList.length"
      >
        <h3 style="text-align: justify; vertical-align: middle">
          {{ AttackList.length }} total attacks &nbsp;&nbsp;&nbsp;&nbsp;
        </h3>
      </span>
    </div>

    <!-- Mat table Start-->
    <mat-table [dataSource]="dataSource" matSort 
    class="mat-elevation-z8" matTableExporter
    #exporter="matTableExporter" [hiddenColumns]="[5]">
      <ng-container matColumnDef="sub_technique_id">
        <mat-header-cell *matHeaderCellDef mat-sort-header class="tableheader">
          Technique id
        </mat-header-cell>
        <mat-cell *matCellDef="let element" class="tablerow">
          {{ element.sub_technique_id }}
        </mat-cell>
      </ng-container>

      <ng-container matColumnDef="mitre_version">
        <mat-header-cell *matHeaderCellDef mat-sort-header class="tableheader">
          Mitre Version
        </mat-header-cell>
        <mat-cell *matCellDef="let element" class="tablerow">
          {{ element.mitre_version }}
        </mat-cell>
      </ng-container>

      <ng-container matColumnDef="script">
        <mat-header-cell *matHeaderCellDef mat-sort-header class="tableheader">
          Script
        </mat-header-cell>
        <mat-cell
          *matCellDef="let element"
          class="tablerow"
          style="padding-left: 15px"
        >
          {{ element.script }}
        </mat-cell>
      </ng-container>

      <ng-container matColumnDef="support">
        <mat-header-cell *matHeaderCellDef class="tableheader"
          >Support</mat-header-cell
        >
        <mat-cell *matCellDef="let element">
          <div
            *ngIf="element.support === 'yes'; else other_content"
            style="padding-left: 25px"
          >
            <input
              class="checkmark"
              type="checkbox"
              name="support"
              value="yes"
              checked
              disabled
            />
            <span class="cdk-visually-hidden">{{ element.support }}</span>
          </div>
          <ng-template #other_content>
            <div style="padding-left: 25px">
              <input
                class="checkmark"
                type="checkbox"
                name="support"
                value="no"
                disabled
              />
              <span class="cdk-visually-hidden">{{ element.support }}</span>
            </div>
          </ng-template>
        </mat-cell>
      </ng-container>

      <ng-container matColumnDef="comment">
        <mat-header-cell *matHeaderCellDef mat-sort-header class="tableheader"
          >Comment</mat-header-cell
        >
        <mat-cell *matCellDef="let element" class="tablerow">
          {{ element.comment }}
        </mat-cell>
      </ng-container>

      <ng-container matColumnDef="actions">
        <mat-header-cell *matHeaderCellDef class="tableheader">
          Actions
        </mat-header-cell>
        <mat-cell *matCellDef="let element" style="padding-left: 0px; padding-right: 35px;">
          <button
            type="button"
            class="btn btn-light mr-1"
            (click)="viewJson(jsonView, element)"
          >
            <svg
              xmlns="http://www.w3.org/2000/svg"
              width="14"
              height="14"
              fill="currentColor"
              class="bi bi-eye"
              viewBox="0 0 16 16"
            >
              <path
                d="M16 8s-3-5.5-8-5.5S0 8 0 8s3 5.5 8 5.5S16 8 16 8zM1.173 8a13.133 13.133 0 0 1 1.66-2.043C4.12 4.668 5.88 3.5 8 3.5c2.12 0 3.879 1.168 5.168 2.457A13.133 13.133 0 0 1 14.828 8c-.058.087-.122.183-.195.288-.335.48-.83 1.12-1.465 1.755C11.879 11.332 10.119 12.5 8 12.5c-2.12 0-3.879-1.168-5.168-2.457A13.134 13.134 0 0 1 1.172 8z"
              />
              <path
                d="M8 5.5a2.5 2.5 0 1 0 0 5 2.5 2.5 0 0 0 0-5zM4.5 8a3.5 3.5 0 1 1 7 0 3.5 3.5 0 0 1-7 0z"
              />
            </svg>
          </button>
          
          <button
            type="button"
            class="btn btn-light mr-1"
            (click)="update(content, element)"
          >
            <svg
              xmlns="http://www.w3.org/2000/svg"
              width="14"
              height="14"
              fill="currentColor"
              class="bi bi-pencil-square"
              viewBox="0 0 16 16"
            >
              <path
                d="M15.502 1.94a.5.5 0 0 1 0 .706L14.459 3.69l-2-2L13.502.646a.5.5 0 0 1 .707 0l1.293 1.293zm-1.75 2.456l-2-2L4.939 9.21a.5.5 0 0 0-.121.196l-.805 2.414a.25.25 0 0 0 .316.316l2.414-.805a.5.5 0 0 0 .196-.12l6.813-6.814z"
              />
              <path
                fill-rule="evenodd"
                d="M1 13.5A1.5 1.5 0 0 0 2.5 15h11a1.5 1.5 0 0 0 1.5-1.5v-6a.5.5 0 0 0-1 0v6a.5.5 0 0 1-.5.5h-11a.5.5 0 0 1-.5-.5v-11a.5.5 0 0 1 .5-.5H9a.5.5 0 0 0 0-1H2.5A1.5 1.5 0 0 0 1 2.5v11z"
              />
            </svg>
          </button>
          <!-- dataItem.attack_id -->
          <button
            type="button"
            class="btn btn-light mr-1"
            (click)="deleteClick(element.attack_id)"
          >
            <svg
              xmlns="http://www.w3.org/2000/svg"
              width="16"
              height="16"
              fill="currentColor"
              class="bi bi-trash"
              viewBox="0 0 16 16"
            >
              <path
                d="M5.5 5.5A.5.5 0 0 1 6 6v6a.5.5 0 0 1-1 0V6a.5.5 0 0 1 .5-.5zm2.5 0a.5.5 0 0 1 .5.5v6a.5.5 0 0 1-1 0V6a.5.5 0 0 1 .5-.5zm3 .5a.5.5 0 0 0-1 0v6a.5.5 0 0 0 1 0V6z"
              />
              <path
                fill-rule="evenodd"
                d="M14.5 3a1 1 0 0 1-1 1H13v9a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V4h-.5a1 1 0 0 1-1-1V2a1 1 0 0 1 1-1H6a1 1 0 0 1 1-1h2a1 1 0 0 1 1 1h3.5a1 1 0 0 1 1 1v1zM4.118 4L4 4.059V13a1 1 0 0 0 1 1h6a1 1 0 0 0 1-1V4.059L11.882 4H4.118zM2.5 3V2h11v1h-11z"
              />
            </svg>
          </button>
        </mat-cell>
      </ng-container>

      <mat-header-row *matHeaderRowDef="displayedColumns"></mat-header-row>
      <mat-row *matRowDef="let row; columns: displayedColumns"></mat-row>
    </mat-table>
  </div>
</div>
